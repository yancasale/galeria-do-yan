---
import Modal from "./Modal.astro";
import FilterPopover from "./FilterPopover.astro";

const { works } = Astro.props;
---

<section class="grid">
  {
    works.map((work) => (
      <article
        class="item"
        data-type={work.data.type}
        data-title={work.data.title}
        data-date={work.data.date.toDateString()}
        data-description={work.body}
        onClick="openModal(this, event)"
      >
        <div class="image-box">
          <img src={work.data.cover} alt={work.data.title} />
        </div>

        <p class="meta">{work.data.type}</p>
      </article>
    ))
  }
</section>

<style>
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 2.5rem;
  }

  .image-box {
    width: 100%;
  }

  .image-box {
    width: 100%;
    aspect-ratio: 3 / 4;
    overflow: hidden;
  }

  .image-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .title {
    text-align: center;
    margin-top: 0.75rem;
    color: #444;
  }

  .meta {
    text-align: center;
    font-size: 0.8rem;
    color: #999;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .item {
    padding: 1rem;
    transition: background 0.3s ease;
    cursor: pointer;
  }

  .item img {
    transition: transform 0.4s ease;
  }

  .item:hover img {
    transform: scale(1.03);
  }

  @media (hover: hover) {
    .item:hover img {
      transform: scale(1.03);
    }
  }

  .item:hover {
    background: #f2f2f2;
  }

  p {
    text-align: center;
    color: #888;
    margin-top: 0.75rem;
  }
</style>

<script>
  const items = Array.from(document.querySelectorAll(".item"));
  const filterButtons = document.querySelectorAll("[data-filter]");

  let activeFilter = "all";
  let visibleCount = 12;

  function updateVisibility() {
    let shown = 0;

    items.forEach((item) => {
      const matchesFilter =
        activeFilter === "all" || item.dataset.type === activeFilter;

      if (matchesFilter && shown < visibleCount) {
        item.style.display = "block";
        shown++;
      } else {
        item.style.display = "none";
      }
    });
  }

  // Filter button clicks
  filterButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      filterButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      activeFilter = btn.dataset.filter;
      visibleCount = 12; // reset scroll on filter change
      updateVisibility();
    });
  });

  // Infinite scroll
  window.addEventListener("scroll", () => {
    if (
      window.innerHeight + window.scrollY >=
      document.body.offsetHeight - 300
    ) {
      visibleCount += 6;
      updateVisibility();
    }
  });

  // Initial render
  updateVisibility();
</script>
